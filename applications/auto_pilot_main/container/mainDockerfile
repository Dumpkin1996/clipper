FROM tensorflow/tensorflow:1.12.0-gpu-py3 
RUN apt-get update
RUN apt-get update
RUN apt-get install python3 python3-pip -y
RUN apt-get install libsm6 libxrender1 libfontconfig1 libxext-dev -y

# docker build -f ./mainDockerfile -t auto_pilot_main:raft .
# docker run -p 10000:10000 -it auto_pilot_main:raft
# docker run --runtime=nvidia -p 10000:10000 -it auto_pilot_main:raft

RUN pip3 install scipy
RUN pip3 install pillow
RUN pip3 install numpy
RUN pip3 install keras
RUN pip3 install tensorflow
RUN pip3 install opencv-contrib-python

ADD c0_Entry_Point /container/c0_Entry_Point
ADD c1_Image_Preprocessing /container/c1_Image_Preprocessing
ADD c2_Obstacle_Detection /container/c2_Obstacle_Detection
ADD c3_Route_Planning /container/c3_Route_Planning
ADD c4_Algo1 /container/c4_Algo1
ADD c5_Algo2 /container/c5_Algo2
ADD c6_Conclusion /container/c6_Conclusion
ADD dataset /container/dataset
ADD main.py /container

# for RAFT !!!!! IMPORTANT!!!!!!
RUN pip3 install pyyaml

RUN apt-get install git -y

RUN pip3 install git+https://github.com/ucbrise/clipper.git@develop#subdirectory=clipper_admin


RUN apt-get update -qq \
      && apt-get install -y -qq libzmq5 libzmq5-dev redis-server libsodium18 build-essential

ENV PIP_DEFAULT_TIMEOUT=100
RUN pip install --upgrade pip

RUN pip install -q cloudpickle==0.5.* pyzmq==17.0.* prometheus_client==0.1.* \
    pyyaml>=4.2b1 jsonschema==2.6.* redis==2.10.* psutil==5.4.* flask==0.12.2 

ADD closure.py /container
ADD rpc.py /container
ADD metrics_config.yaml /container
ADD main.py /container

# /container nows contains: 
# c0_entryContainer c1_speechRecognition/ c2_imageCaptionGenerator/ c3_nlpMappingGenerator/ c4_questionAnswering/ main.py

# Crucial
WORKDIR /container

# CMD ["python3", "/container/closure.py"]
CMD ["python3", "/container/main.py"]

EXPOSE 10000
