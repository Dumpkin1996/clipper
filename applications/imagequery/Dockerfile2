FROM tensorflow/tensorflow:1.12.0-gpu-py3 
RUN apt-get update
RUN pip install numpy nltk
RUN python -m nltk.downloader all
RUN apt install wget
RUN pip3 install grpcio
RUN pip3 install protobuf

# container/ will have: predict.py, captionData/, im2txt/
ADD imagequery/c2_imageCaptionGenerator/app /container/
ADD imagequery/c2_imageCaptionGenerator/captionData /container/captionData
ADD imagequery/c2_imageCaptionGenerator/im2txt /container/im2txt

# download pre-trained models 
RUN chmod 777 /container/im2txt/model/downloadModels.sh
RUN /container/im2txt/model/downloadModels.sh
RUN mv /notebooks/newmodel.ckpt-2000000.meta /container/im2txt/model
RUN mv /notebooks/newmodel.ckpt-2000000.data-00000-of-00001 /container/im2txt/model

# download datasets, untar and reindex images: 101_ObjectCategories
# /container/im2txt/data/imageDataset will contains image1.jpg, image2.jpg, image3.jpg, ..., and other folders
# RUN wget --progress=bar:force http://www.vision.caltech.edu/Image_Datasets/Caltech101/101_ObjectCategories.tar.gz
# RUN mv /notebooks/101_ObjectCategories.tar.gz /container/im2txt/data/imageDataset
# RUN chmod 777 /container/im2txt/data/imageDataset/untar.sh 
# RUN /container/im2txt/data/imageDataset/untar.sh 
# RUN chmod 777 /container/im2txt/data/imageDataset/rename.sh 
# RUN /container/im2txt/data/imageDataset/rename.sh

RUN wget --progress=bar:force https://groups.csail.mit.edu/sls/downloads/flickraudio/downloads/flickr_audio.tar.gz
RUN mv /notebooks/flickr_audio.tar.gz /container/im2txt/data/imageDataset2
RUN chmod 777 /container/im2txt/data/imageDataset2/untarRename.sh 
RUN /container/im2txt/data/imageDataset2/untarRename.sh

RUN pip3 install unzip
RUN wget --progress=bar:force https://www.kaggle.com/rtatman/speech-accent-archive/downloads/speech-accent-archive.zip/2
RUN mv /notebooks/speech-accent-archive.zip /container/im2txt/data/imageDataset3
RUN unzip /container/im2txt/data/imageDataset3/speech-accent-archive.zip -d /container/im2txt/data/imageDataset3
RUN unzip /container/im2txt/data/imageDataset3/speech-accent-archive/recordings.zip -d /container/im2txt/data/imageDataset3/speech-accent-archive/
RUN ls /container/im2txt/data/imageDataset3/speech-accent-archive/

ADD grpc/app/container_entry.sh /container/
ADD grpc/app/server.py /container/
ADD grpc/app/model_pb2_grpc.py /container/
ADD grpc/app/model_pb2.py /container/
ADD grpc/app/proxy_pb2_grpc.py /container/
ADD grpc/app/proxy_pb2.py /container/

CMD ["/container/container_entry.sh", "c2", "/container/server.py"]

EXPOSE 9000
