FROM ubuntu:bionic
RUN apt-get update
RUN apt-get install wget python3 python3-pip -y
RUN pip3 install grpcio
RUN pip3 install protobuf
RUN pip3 install deepspeech-gpu

# container/ will have predict.py, data/
ADD imagequery/c1_speechRecognition/app /container/
ADD imagequery/c1_speechRecognition/data /container/data

# dataset source: http://festvox.org/cmu_arctic/
RUN wget --progress=bar:force http://festvox.org/cmu_arctic/cmu_arctic/packed/cmu_us_awb_arctic-0.95-release.zip
RUN mv $(find / -name cmu_us_awb_arctic-0.95-release.zip) /container/data/dataset1
RUN chmod 777 /container/data/dataset1/unzipRename.sh
RUN /container/data/dataset1/unzipRename.sh

# download pre-trained model
RUN wget --progress=bar:force https://github.com/mozilla/DeepSpeech/releases/download/v0.4.1/deepspeech-0.4.1-models.tar.gz
RUN tar xvfz $(find / -name deepspeech-0.4.1-models.tar.gz)
RUN mv /models /container/models
RUN ls /container
RUN ls /container/models

ADD grpc/app/container_entry.sh /container/
ADD grpc/app/server.py /container/
ADD grpc/app/model_pb2_grpc.py /container/
ADD grpc/app/model_pb2.py /container/
ADD grpc/app/proxy_pb2_grpc.py /container/
ADD grpc/app/proxy_pb2.py /container/

# CMD ["/container/container_entry.sh", "c1", "/container/server.py"]

EXPOSE 8000