FROM ubuntu:bionic
RUN apt-get update
RUN apt-get install wget zip unzip python3 python3-pip -y
RUN pip3 install SpeechRecognition
RUN pip3 install grpcio
RUN pip3 install protobuf

# for downloading and renameing dataset3
RUN apt-get install curl -y
RUN apt-get install ffmpeg -y

# for pydub in truncate.py
RUN pip3 install pydub
RUN apt-get install ffmpeg libavcodec-extra -y

# for listing files in truncate.py
RUN pip3 install glob3


# container/ will have predict.py, data/
ADD imagequery/c1_speechRecognition/app /container/
ADD imagequery/c1_speechRecognition/data /container/data

# dataset1 
# dataset source: http://festvox.org/cmu_arctic/
# RUN wget --progress=bar:force http://festvox.org/cmu_arctic/cmu_arctic/packed/cmu_us_awb_arctic-0.95-release.zip
# RUN mv $(find / -name cmu_us_awb_arctic-0.95-release.zip) /container/data/dataset1
# RUN chmod 777 /container/data/dataset1/unzipRename.sh
# RUN /container/data/dataset1/unzipRename.sh

# dataset2
# reference: https://groups.csail.mit.edu/sls/downloads/flickraudio/index.cgi
# RUN wget --progress=bar:force https://groups.csail.mit.edu/sls/downloads/flickraudio/downloads/flickr_audio.tar.gz
# RUN mv $(find / -name flickr_audio.tar.gz) /container/data/dataset2
# RUN chmod 777 /container/data/dataset2/untarRename.sh 
# RUN /container/data/dataset2/untarRename.sh

# dataset3
# download reference: https://www.kaggle.com/general/6604
# dataset refernce: https://www.kaggle.com/rtatman/speech-accent-archive/
# RUN curl 'https://storage.googleapis.com/kaggle-datasets/4114/6391/speech-accent-archive.zip?GoogleAccessId=web-data@kaggle-161607.iam.gserviceaccount.com&Expires=1558923578&Signature=nriiruUcrYCm7Hr4rK3kByDRerT3FTHP%2B1GeS3gkPRnNrdTy06VV31Fgch3UpvWuGCsL8eSKh5xnrWzC3gOP95hL523xyNVRJDcsxJ4L4klwpJoLln9ohmPkNPVfIlSH6AVaRH208Aa%2F5BsLFoMIo3rh3jE0D09nMfA2xvAxuxK5QPXp86ZdRtYMMHfBJ5ah5niNjprEiAOLhgumo7k3TzNIRUZi0zn6L7i8Q9XSRuShWQne8RRiGoMeggXtUFqkTnZDbomeI5vnDwT8K%2FOWnY9o91ncd8muYWFnH5BdXOPnJZaDvfg%2BR7C8uApcxcgAhnUjP9jfZJExUsf%2BSMXPKg%3D%3D' -H 'authority: storage.googleapis.com' -H 'pragma: no-cache' -H 'cache-control: no-cache' -H 'upgrade-insecure-requests: 1' -H 'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' -H 'referer: https://www.kaggle.com/' -H 'accept-encoding: gzip, deflate, br' -H 'accept-language: en,zh;q=0.9,zh-CN;q=0.8' --compressed -o speech-accent-archive.zip
RUN curl 'https://storage.googleapis.com/kaggle-datasets/4114/6391/speech-accent-archive.zip?GoogleAccessId=web-data@kaggle-161607.iam.gserviceaccount.com&Expires=1559377724&Signature=bssX9KooUn3i4igK3nNpHiap3j%2BV3QFrzz84NhCwkJILXKi2plbZsABqblSI1YfoNvnbHJ35wMr2S%2Bpai2%2BxA%2BN42n5YV%2BllgL1Ae0oZdK0%2Bzzru%2FbegJMw%2Bo5Q3GPbiC4lpqsAwB9FbV64JwtO28jtC1PMdXWhObx5Qftz3fFiflQ1kmKyfhW233gbLeDaS%2BbEM3u1eilrHKCFnnULiamBbF%2BYTT7C5ityX7aayZbRVxYMSVVMBr8zFe%2F5OjdbHdLPPOfSE1G2fHeyu6H4tS2P2dNXZR98zc1%2FK2UrJbMX17jIMq%2B9%2F7C6IwvAtFODT9Wt63UPVFNCt8cp4tfGtQA%3D%3D' -H 'authority: storage.googleapis.com' -H 'pragma: no-cache' -H 'cache-control: no-cache' -H 'upgrade-insecure-requests: 1' -H 'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36' -H 'accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3' -H 'referer: https://www.kaggle.com/' -H 'accept-encoding: gzip, deflate, br' -H 'accept-language: en,zh;q=0.9,zh-CN;q=0.8' -H 'cookie: _ga=GA1.3.1190370773.1559048531; _gid=GA1.3.632917932.1559048531' --compressed -o speech-accent-archive.zip
RUN mv $(find / -name speech-accent-archive.zip) /container/data/dataset3
RUN unzip /container/data/dataset3/speech-accent-archive.zip -d /container/data/dataset3
# /container/data/dataset3 now contains:reading-passage.txt, recordings.zip, speakers_all.csv
RUN unzip /container/data/dataset3/recordings.zip -d /container/data/dataset3/
RUN chmod 777 /container/data/dataset3/rename.sh
RUN /container/data/dataset3/rename.sh
RUN python3 /container/data/dataset3/truncate.py

ADD grpc/app/container_entry.sh /container/
ADD grpc/app/server.py /container/
ADD grpc/app/model_pb2_grpc.py /container/
ADD grpc/app/model_pb2.py /container/
ADD grpc/app/proxy_pb2_grpc.py /container/
ADD grpc/app/proxy_pb2.py /container/

CMD ["python3", "predict.py"]
# CMD ["/container/container_entry.sh", "c1", "/container/server.py"]

EXPOSE 8000