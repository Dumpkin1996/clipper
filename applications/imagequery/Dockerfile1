FROM nvidia/cuda:9.0-cudnn7-devel-ubuntu16.04 
# Have to use 9.0 version, instead of 10.0 version, though the official document says that it is supported with cuda 10.0.
# If you use nvidia/cuda:9.0-cudnn7-devel-ubuntu16.04, "ImportError: libcusolver.so.9.0: cannot open shared object file: No such file or directory"
# would appear. This is essentially just a naming problem, but annoying.
RUN apt-get update
RUN apt-get install wget python3 python3-pip -y
RUN pip3 install grpcio
RUN pip3 install protobuf
RUN pip3 install deepspeech-gpu

ADD imagequery/c1_speechRecognition/app /container/
ADD imagequery/c1_speechRecognition/data /container/data

# dataset source: http://festvox.org/cmu_arctic/
RUN wget --progress=bar:force http://festvox.org/cmu_arctic/cmu_arctic/packed/cmu_us_awb_arctic-0.95-release.zip
RUN mv $(find / -name cmu_us_awb_arctic-0.95-release.zip) /container/data/dataset1
RUN chmod 777 /container/data/dataset1/unzipRename.sh
RUN /container/data/dataset1/unzipRename.sh

# download pre-trained model
RUN wget --progress=bar:force https://github.com/mozilla/DeepSpeech/releases/download/v0.4.1/deepspeech-0.4.1-models.tar.gz
RUN tar xvfz $(find / -name deepspeech-0.4.1-models.tar.gz)
RUN mv /models /container/models

# /container has: predict.py, data, models
# /container/models has: alphabet.txt, lm.binary, output_graph.pb, output_graph.pbmm. output_graph.rounded.pb, output_graph.rounded.pbmm, trie

ADD grpc/app/container_entry.sh /container/
ADD grpc/app/server.py /container/
ADD grpc/app/model_pb2_grpc.py /container/
ADD grpc/app/model_pb2.py /container/
ADD grpc/app/proxy_pb2_grpc.py /container/
ADD grpc/app/proxy_pb2.py /container/

# RUN apt-get install nvidia-cuda-dev -y
# RUN python3 /container/predict.py --model /container/models/output_graph.pbmm --alphabet /container/models/alphabet.txt --lm /container/models/lm.binary --trie /container/models/trie --audio /container/data/dataset1/cmu_us_awb_arctic/wav/0001.wav
# RUN python3 /container/predict.py --model /container/models/output_graph.pbmm --alphabet /container/models/alphabet.txt --audio /container/data/dataset1/cmu_us_awb_arctic/wav/0001.wav
# CMD ["deepspeech","--model","/container/models/output_graph.pbmm","--alphabet","/container/models/alphabet.txt","--audio","/container/data/dataset1/cmu_us_awb_arctic/wav/0001.wav"]

# CMD ["/container/container_entry.sh", "c1", "/container/server.py"]

EXPOSE 8000