FROM ubuntu:18.04
RUN apt-get update
RUN apt-get install python3 python3-pip -y

# docker build -f ./mainDockerfile -t prediction_main:raft .
# docker run -it prediction_main:raft
# docker run --runtime=nvidia -p 10000:10000 -it prediction_main:raft
# docker run --runtime=nvidia -d -p 10000:10000 -it prediction_main:raft


RUN pip3 install pandas quandl grpcio protobuf 
RUN pip3 install numpy tweepy statsmodels
RUN pip3 install spacy
RUN python3 -m spacy download en_core_web_sm
RUN pip3 install nltk
RUN python3 -m spacy download en
RUN apt-get update
RUN apt-get install python3-all-dev build-essential swig git libpulse-dev libasound2-dev -y
RUN pip3 install sklearn keras tensorflow
RUN pip3 install fastai
RUN pip3 install scipy==1.2 --upgrade

ADD c1_Stock_Price_Retriever /container/c1_Stock_Price_Retriever
ADD c2_Twitter_Collector /container/c2_Twitter_Collector
ADD c3_Tokenizer /container/c3_Tokenizer
ADD c4_Sentiment_Analysis /container/c4_Sentiment_Analysis
ADD c5_LSTM_Predictor /container/c5_LSTM_Predictor
ADD c6_Mem /container/c6_Mem
ADD c7_ARIMA /container/c7_ARIMA
ADD c8_KNN /container/c8_KNN
ADD c9_RandomForest /container/c9_RandomForest
ADD c10_Regression /container/c10_Regression
ADD c11_Conclusion /container/c11_Conclusion

# for RAFT !!!!! IMPORTANT!!!!!!
RUN pip3 install pyyaml

RUN apt-get install git -y

RUN pip3 install git+https://github.com/ucbrise/clipper.git@develop#subdirectory=clipper_admin


RUN apt-get update -qq \
      && apt-get install -y -qq libzmq5 libzmq5-dev redis-server build-essential
RUN apt-get install libsodium18

ENV PIP_DEFAULT_TIMEOUT=100
RUN pip install --upgrade pip

RUN pip install -q cloudpickle==0.5.* pyzmq==17.0.* prometheus_client==0.1.* \
    pyyaml>=4.2b1 jsonschema==2.6.* redis==2.10.* psutil==5.4.* flask==0.12.2 

ADD closure.py /container
ADD rpc.py /container
ADD metrics_config.yaml /container
ADD main.py /container

# /container nows contains: 
# c0_entryContainer c1_speechRecognition/ c2_imageCaptionGenerator/ c3_nlpMappingGenerator/ c4_questionAnswering/ main.py

# Crucial
WORKDIR /container

# CMD ["python3", "/container/closure.py"]
CMD ["python3", "/container/main.py"]

EXPOSE 10000